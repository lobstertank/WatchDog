name: "Deploy to Production"

on:
  workflow_dispatch:  # Manual trigger
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
    - name: Create .env file
      run: |
        echo "FINOLOG_API_KEY=${{ secrets.FINOLOG_API_KEY }}" > .env
        echo "FINOLOG_BIZ_ID=${{ secrets.FINOLOG_BIZ_ID }}" >> .env
        echo "THREATENING_ACCOUNT_IDS=${{ secrets.THREATENING_ACCOUNT_IDS }}" >> .env
        echo "THREATENING_THRESHOLD=${{ secrets.THREATENING_THRESHOLD }}" >> .env
        echo "THREATENING_DAYS_AHEAD=${{ secrets.THREATENING_DAYS_AHEAD }}" >> .env
        echo "MAIN_BOT_TOKEN=${{ secrets.MAIN_BOT_TOKEN }}" >> .env
        echo "MAIN_BOT_ALLOWED_USERS=${{ secrets.MAIN_BOT_ALLOWED_USERS }}" >> .env
        echo "TEST_BOT_TOKEN=${{ secrets.TEST_BOT_TOKEN }}" >> .env
        echo "TEST_BOT_ALLOWED_USERS=${{ secrets.TEST_BOT_ALLOWED_USERS }}" >> .env
        
    - name: Test SSH connection
      run: |
        echo "Testing SSH connection..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSH connection successful'"
        
    - name: Stop existing service
      run: |
        echo "Stopping existing service..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ~/watchdog && pkill -f launcher.py || true"
        
    - name: Create logs directory
      run: |
        echo "Creating logs directory..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ~/watchdog/logs"
        
    - name: Deploy .env file
      run: |
        echo "Deploying .env file..."
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa .env ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
    - name: Deploy Python files
      run: |
        echo "Deploying Python files..."
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa *.py ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
    - name: Deploy shell scripts
      run: |
        echo "Deploying shell scripts..."
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa *.sh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
    - name: Deploy holiday files
      run: |
        echo "Deploying holiday files..."
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa holidays_*.json ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
    - name: Set execute permissions
      run: |
        echo "Setting execute permissions..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ~/watchdog && chmod +x *.sh"
        
    - name: Restart service
      run: |
        echo "Restarting service..."
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ~/watchdog && nohup python3 launcher.py > logs/launcher.log 2>&1 &"