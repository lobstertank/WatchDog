name: "Deploy to Production"

on:
  workflow_dispatch:  # Manual trigger
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
    - name: Create .env file
      run: |
        echo "FINOLOG_API_KEY=${{ secrets.FINOLOG_API_KEY }}" > .env
        echo "FINOLOG_BIZ_ID=${{ secrets.FINOLOG_BIZ_ID }}" >> .env
        echo "THREATENING_ACCOUNT_IDS=${{ secrets.THREATENING_ACCOUNT_IDS }}" >> .env
        echo "THREATENING_THRESHOLD=${{ secrets.THREATENING_THRESHOLD }}" >> .env
        echo "THREATENING_DAYS_AHEAD=${{ secrets.THREATENING_DAYS_AHEAD }}" >> .env
        echo "MAIN_BOT_TOKEN=${{ secrets.MAIN_BOT_TOKEN }}" >> .env
        echo "MAIN_BOT_ALLOWED_USERS=${{ secrets.MAIN_BOT_ALLOWED_USERS }}" >> .env
        echo "TEST_BOT_TOKEN=${{ secrets.TEST_BOT_TOKEN }}" >> .env
        echo "TEST_BOT_ALLOWED_USERS=${{ secrets.TEST_BOT_ALLOWED_USERS }}" >> .env
        
    - name: Deploy to server
      run: |
        # Stop the existing service
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ~/watchdog && pkill -f launcher.py || true"
        
        # Create logs directory
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ~/watchdog/logs"
        
        # Deploy files
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa .env ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa *.py ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa *.sh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa *.json ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
        # Set execute permissions
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ~/watchdog && chmod +x *.sh"
        
        # Restart the service
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ~/watchdog && nohup python3 launcher.py > logs/launcher.log 2>&1 &"