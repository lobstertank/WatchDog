name: Deploy WatchDog to Production

on:
  push:
    branches: [ master ]
    paths:
      - '*.py'
      - '*.json'
      - '*.sh'
      - 'requirements.txt'
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Create backup on server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd ~/watchdog &&
          tar -czf WG_backup_\$(date +%Y%m%d_%H%M%S).tgz *.py *.json *.sh requirements.txt 2>/dev/null || true
        "
        
    - name: Deploy Python files
      run: |
        scp -o StrictHostKeyChecking=no launcher.py launcher_test.py telegram_bot.py api_functions.py telegram_functions.py config.py contacts.py ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
    - name: Deploy support files
      run: |
        scp -o StrictHostKeyChecking=no holiday_checker_json.py holiday_updater_minimal.py ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
    - name: Deploy data files
      run: |
        scp -o StrictHostKeyChecking=no holidays_2025.json holidays_2026.json requirements.txt ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
    - name: Deploy scripts
      run: |
        scp -o StrictHostKeyChecking=no run_bot.sh run_bot_with_holidays.sh run_holiday_updater.sh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/watchdog/
        
    - name: Set script permissions
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd ~/watchdog &&
          chmod +x *.sh
        "
        
    - name: Test imports
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd ~/watchdog &&
          python3 -c 'import launcher, telegram_bot, api_functions, telegram_functions; print(\"‚úÖ All imports successful\")'
        "
        
    - name: Test main bot
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd ~/watchdog &&
          timeout 10s python3 launcher.py || echo 'Test completed (timeout expected)'
        "
        
    - name: Test test bot
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd ~/watchdog &&
          timeout 10s python3 launcher_test.py || echo 'Test completed (timeout expected)'
        "
        
    - name: Verify deployment
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd ~/watchdog &&
          echo '=== Deployed files ===' &&
          ls -la *.py &&
          echo '=== Script permissions ===' &&
          ls -la *.sh &&
          echo '=== Data files ===' &&
          ls -la *.json
        "
        
    - name: Deployment summary
      run: |
        echo "üöÄ WatchDog deployment completed successfully!"
        echo "üìÅ Files deployed: Python modules, scripts, data files"
        echo "‚úÖ Tests passed: imports, main bot, test bot"
        echo "üîß Next steps: Monitor logs and cron jobs"
